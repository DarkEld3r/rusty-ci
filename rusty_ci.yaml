# Continuous integration for managing Rusty-CI repo
requires: 0.9.0

master:
  title: "RustyCI Continuous Integration"
  title-url: "https://github.com/adam-mcdaniel/rusty-ci"
  # Local IP for linux container
  webserver-ip: 10.35.66.130
  webserver-port: 9000
  repo: "https://github.com/adam-mcdaniel/rusty-ci"
  poll-interval: 120


merge-request-handler:
  version-control-system: github
  owner: adam-mcdaniel
  repo-name: rusty-ci
  whitelist:
    - adam-mcdaniel


workers:
  test-worker:
    master-ip: localhost
    working-dir: 'test-worker'

  release-worker:
    master-ip: localhost
    working-dir: 'release-worker'


schedulers:
  source-change:
    builders:
      - merge-test
      - cargo-test
      - cargo-build
      - cargo-clippy
    branch: ".*"
    triggers:
      - ".*Cargo.toml"
      - ".*\\.rs"
    password: "ok to test"

  # Detects a release change in master
  release-change:
    builders:
      - merge-test
      - cargo-test
      - cargo-build
      - cargo-clippy
    branch: "master"
    triggers:
      - ".*"
    password: "ok to test"

  # If new release passes tests, update self
  should-update:
    builders:
      - update-self
    depends: "release-change"


builders:
  update-self:
    script:
      - chmod +x update.sh
      - ./update.sh
    workers:
      - release-worker
    repo: "https://github.com/adam-mcdaniel/rusty-ci"

  merge-test:
    script:
      - git pull origin master
      - cargo test
      - cargo build --release
    workers:
      - test-worker
    repo: "https://github.com/adam-mcdaniel/rusty-ci"

  cargo-test:
    script:
      - cargo test
    workers:
      - test-worker
    repo: "https://github.com/adam-mcdaniel/rusty-ci"

  cargo-build:
    script:
      - cargo build --release
    workers:
      - test-worker
    repo: "https://github.com/adam-mcdaniel/rusty-ci"

  cargo-clippy:
    script:
      - cargo clippy
    workers:
      - test-worker
    repo: "https://github.com/adam-mcdaniel/rusty-ci"