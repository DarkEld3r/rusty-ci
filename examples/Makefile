
workerdirs := /root/ci_bot/vm-worker /root/ci_bot/test-worker /root/ci_bot/compiler-worker
masterdir := "master"


all: install start

start:
	buildbot stop master
	buildbot reconfig master
	buildbot cleanupdb master
	. venv/bin/activate; buildbot start master;
	-. venv/bin/activate; $(foreach dir,$(workerdirs),buildbot-worker restart $(dir);)


install:
	sudo apt-get install python3-dev
	sudo apt-get install python3-pip

	python3 -m venv venv
	. venv/bin/activate; python3 -m pip install -U pip; python3 -m pip install 'buildbot[bundle]';
	. venv/bin/activate; python3 -m pip install buildbot-worker setuptools-trial
	. venv/bin/activate; buildbot create-master $(masterdir);
	echo "\n# -*- python -*-\n# ex: set filetype=python:\nimport re\nfrom buildbot.plugins import *\n\n# This is a sample buildmaster config file. It must be installed as\n# 'master.cfg' in your buildmaster's base directory.\n\n# This is the dictionary that the buildmaster pays attention to. We also use\n# a shorter alias to save typing.\nc = BuildmasterConfig = {}\n\n####### WORKERS\n\n# The 'workers' list defines the set of recognized workers. Each element is\n# a Worker object, specifying a unique worker name and password.  The same\n# worker name and password must be configured on the worker.\nc['workers'] = [worker.Worker('dragon-vm-worker', 'pass'), worker.Worker('IT_WORKED', 'pass'), worker.Worker('dragon-compiler-worker', 'pass')]\nc['protocols'] = {'pb': {'port': 9989}}\n\n\nc['change_source'] = []\nc['change_source'].append(changes.GitPoller(\n        'https://github.com/adam-mcdaniel/dragon',\n        workdir='gitpoller-workdir', branches=True, # poll all branches\n        pollInterval=5))\n\nc['schedulers'] = []\nc['builders'] = []\n\n\n@util.renderer\ndef vm_change_triggers(props):\n    builders = ['dragon-vm-build']\n\n    triggers = ['.*\\.cpp', '.*\\.hpp']\n\n    for f in props.files:\n        for regex in triggers:\n            if re.match(regex, str(f)):\n                return builders\n\n    return []\n\nc['schedulers'].append(schedulers.AnyBranchScheduler(name='vm_change',\n    change_filter=util.ChangeFilter(branch_re='.*'),\n    builderNames=vm_change_triggers))\n\nc['schedulers'].append(schedulers.ForceScheduler(name='force_vm_change',\n    builderNames=['dragon-vm-build']))\n\n\n\n@util.renderer\ndef compiler_change_triggers(props):\n    builders = ['dragon-compiler-build', 'dragon-testing']\n\n    triggers = ['.*\\.py']\n\n    for f in props.files:\n        for regex in triggers:\n            if re.match(regex, str(f)):\n                return builders\n\n    return []\n\nc['schedulers'].append(schedulers.AnyBranchScheduler(name='compiler_change',\n    change_filter=util.ChangeFilter(branch_re='master'),\n    builderNames=compiler_change_triggers))\n\nc['schedulers'].append(schedulers.ForceScheduler(name='force_compiler_change',\n    builderNames=['dragon-compiler-build', 'dragon-testing']))\n\n\ntemp_factory = util.BuildFactory()\ntemp_factory.addStep(steps.Git(repourl='https://github.com/adam-mcdaniel/dragon', mode='incremental', branch='master', method='clobber', submodules=True))\ntemp_factory.addStep(steps.ShellCommand(command=['rm', '-Rf', 'build'], workdir='./build'))\ntemp_factory.addStep(steps.ShellCommand(command=['mkdir', 'build'], workdir='./build'))\ntemp_factory.addStep(steps.ShellCommand(command=['cmake', '..'], workdir='./build/build'))\ntemp_factory.addStep(steps.ShellCommand(command=['make'], workdir='./build/build'))\nc['builders'].append(\n    util.BuilderConfig(name='dragon-vm-build',\n    workernames=['dragon-vm-worker'],\n    factory=temp_factory))\n        \n\n\ntemp_factory = util.BuildFactory()\ntemp_factory.addStep(steps.Git(repourl='https://github.com/adam-mcdaniel/dragon', mode='incremental', branch='master', method='clobber', submodules=True))\ntemp_factory.addStep(steps.ShellCommand(command=['python3', '-m', 'pip', 'install', '-U', 'lark-parser'], workdir='./build'))\ntemp_factory.addStep(steps.ShellCommand(command=['python3', 'compiler/main.py', '-f', 'examples/script.dn'], workdir='./build'))\nc['builders'].append(\n    util.BuilderConfig(name='dragon-compiler-build',\n    workernames=['dragon-compiler-worker'],\n    factory=temp_factory))\n        \n\n\ntemp_factory = util.BuildFactory()\ntemp_factory.addStep(steps.Git(repourl='https://github.com/adam-mcdaniel/dragon', mode='incremental', branch='master', method='clobber', submodules=True))\ntemp_factory.addStep(steps.ShellCommand(command=['python3', '-m', 'pip', 'install', '-U', 'lark-parser'], workdir='./build'))\ntemp_factory.addStep(steps.ShellCommand(command=['python3', 'compiler/main.py', '-f', 'examples/script.dn'], workdir='./build'))\nc['builders'].append(\n    util.BuilderConfig(name='dragon-testing',\n    workernames=['IT_WORKED'],\n    factory=temp_factory))\n        \n\nc['services'] = []\n\nc['title'] = 'ASGarD CI'\nc['titleURL'] = 'https://code.ornl.gov/asgard/asgard'\n\nc['buildbotURL'] = 'http://10.94.71.124:8010/'\n\nc['www'] = dict(port=8010,\n                plugins=dict(waterfall_view={}, console_view={}, grid_view={}))\n\nc['db'] = {\n    # This specifies what database buildbot uses to store its state.  You can leave\n    # this at its default for all but the largest installations.\n    'db_url' : 'sqlite:///state.sqlite',\n}\n        " > $(masterdir)/master.cfg
	
	mkdir -p /root/ci_bot/vm-worker
	-. venv/bin/activate; buildbot-worker create-worker /root/ci_bot/vm-worker localhost /root/ci_bot/vm-worker pass
	echo "import os\n\nfrom buildbot_worker.bot import Worker\nfrom twisted.application import service\n\nbasedir = '/root/ci_bot/vm-worker'\nrotateLength = 10000000\nmaxRotatedFiles = 10\n\n# if this is a relocatable tac file, get the directory containing the TAC\nif basedir == '.':\n    import os.path\n    basedir = os.path.abspath(os.path.dirname(__file__))\n\n# note: this line is matched against to check that this is a worker\n# directory; do not edit it.\napplication = service.Application('buildbot-worker')\n\nfrom twisted.python.logfile import LogFile\nfrom twisted.python.log import ILogObserver, FileLogObserver\nlogfile = LogFile.fromFullPath(\n    os.path.join(basedir, 'twistd.log'), rotateLength=rotateLength,\n    maxRotatedFiles=maxRotatedFiles)\napplication.setComponent(ILogObserver, FileLogObserver(logfile).emit)\n\nbuildmaster_host = 'localhost'\nport = 9989\nworkername = 'dragon-vm-worker'\npasswd = 'pass'\nkeepalive = 600\numask = None\nmaxdelay = 300\nnumcpus = None\nallow_shutdown = None\nmaxretries = None\n\ns = Worker(buildmaster_host, port, workername, passwd, basedir,\n           keepalive, umask=umask, maxdelay=maxdelay,\n           numcpus=numcpus, allow_shutdown=allow_shutdown,\n           maxRetries=maxretries)\ns.setServiceParent(application)" > /root/ci_bot/vm-worker/buildbot.tac


	mkdir -p /root/ci_bot/test-worker
	-. venv/bin/activate; buildbot-worker create-worker /root/ci_bot/test-worker localhost /root/ci_bot/test-worker pass
	echo "import os\n\nfrom buildbot_worker.bot import Worker\nfrom twisted.application import service\n\nbasedir = '/root/ci_bot/test-worker'\nrotateLength = 10000000\nmaxRotatedFiles = 10\n\n# if this is a relocatable tac file, get the directory containing the TAC\nif basedir == '.':\n    import os.path\n    basedir = os.path.abspath(os.path.dirname(__file__))\n\n# note: this line is matched against to check that this is a worker\n# directory; do not edit it.\napplication = service.Application('buildbot-worker')\n\nfrom twisted.python.logfile import LogFile\nfrom twisted.python.log import ILogObserver, FileLogObserver\nlogfile = LogFile.fromFullPath(\n    os.path.join(basedir, 'twistd.log'), rotateLength=rotateLength,\n    maxRotatedFiles=maxRotatedFiles)\napplication.setComponent(ILogObserver, FileLogObserver(logfile).emit)\n\nbuildmaster_host = 'localhost'\nport = 9989\nworkername = 'IT_WORKED'\npasswd = 'pass'\nkeepalive = 600\numask = None\nmaxdelay = 300\nnumcpus = None\nallow_shutdown = None\nmaxretries = None\n\ns = Worker(buildmaster_host, port, workername, passwd, basedir,\n           keepalive, umask=umask, maxdelay=maxdelay,\n           numcpus=numcpus, allow_shutdown=allow_shutdown,\n           maxRetries=maxretries)\ns.setServiceParent(application)" > /root/ci_bot/test-worker/buildbot.tac


	mkdir -p /root/ci_bot/compiler-worker
	-. venv/bin/activate; buildbot-worker create-worker /root/ci_bot/compiler-worker localhost /root/ci_bot/compiler-worker pass
	echo "import os\n\nfrom buildbot_worker.bot import Worker\nfrom twisted.application import service\n\nbasedir = '/root/ci_bot/compiler-worker'\nrotateLength = 10000000\nmaxRotatedFiles = 10\n\n# if this is a relocatable tac file, get the directory containing the TAC\nif basedir == '.':\n    import os.path\n    basedir = os.path.abspath(os.path.dirname(__file__))\n\n# note: this line is matched against to check that this is a worker\n# directory; do not edit it.\napplication = service.Application('buildbot-worker')\n\nfrom twisted.python.logfile import LogFile\nfrom twisted.python.log import ILogObserver, FileLogObserver\nlogfile = LogFile.fromFullPath(\n    os.path.join(basedir, 'twistd.log'), rotateLength=rotateLength,\n    maxRotatedFiles=maxRotatedFiles)\napplication.setComponent(ILogObserver, FileLogObserver(logfile).emit)\n\nbuildmaster_host = 'localhost'\nport = 9989\nworkername = 'dragon-compiler-worker'\npasswd = 'pass'\nkeepalive = 600\numask = None\nmaxdelay = 300\nnumcpus = None\nallow_shutdown = None\nmaxretries = None\n\ns = Worker(buildmaster_host, port, workername, passwd, basedir,\n           keepalive, umask=umask, maxdelay=maxdelay,\n           numcpus=numcpus, allow_shutdown=allow_shutdown,\n           maxRetries=maxretries)\ns.setServiceParent(application)" > /root/ci_bot/compiler-worker/buildbot.tac

